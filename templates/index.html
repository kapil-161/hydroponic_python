<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CROPGRO Hydroponic Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-success">
        <div class="container-fluid">
            <span class="navbar-brand h1">
                <i class="fas fa-seedling"></i> CROPGRO Hydroponic Simulator
                <span class="badge bg-light text-success ms-2">Advanced Crop Modeling</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Input Panel -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-sliders-h"></i> Simulation Parameters</h5>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 80vh;">
                        
                        <!-- Simulation Configuration -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-cog"></i> Simulation Settings</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Cultivar</label>
                                    <select id="cultivar_id" class="form-select">
                                        <option value="HYDRO_001">Salanova Green Butter</option>
                                        <option value="HYDRO_002">Rex Butterhead</option>
                                        <option value="BUTT_001">Buttercrunch</option>
                                        <option value="ROM_001">Parris Island Cos</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Simulation Mode</label>
                                    <select id="simulation_mode" class="form-select" onchange="toggleSimulationMode()">
                                        <option value="maturity">Until Maturity (Automatic)</option>
                                        <option value="days">Fixed Days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2" id="maturity_options">
                                <div class="col-6">
                                    <label class="form-label">Target Maturity</label>
                                    <select id="target_maturity" class="form-select">
                                        <option value="harvest">Harvest Maturity (HM)</option>
                                        <option value="physiological">Physiological Maturity (PM)</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Maximum Days</label>
                                    <input type="number" id="max_days" class="form-control" value="120" min="30" max="365">
                                </div>
                            </div>
                            <div class="row mt-2" id="fixed_days_options" style="display: none;">
                                <div class="col-6">
                                    <label class="form-label">Days to Simulate</label>
                                    <input type="number" id="simulation_days" class="form-control" value="14" min="1" max="120">
                                </div>
                            </div>
                        </div>

                        <!-- System Configuration -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-industry"></i> System Configuration</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">System ID</label>
                                    <input type="text" id="system_id" class="form-control" value="CROPGRO_001">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">System Type</label>
                                    <select id="system_type" class="form-select">
                                        <option value="NFT">NFT (Nutrient Film Technique)</option>
                                        <option value="DWC">DWC (Deep Water Culture)</option>
                                        <option value="AEROPONICS">Aeroponics</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label class="form-label">Tank Volume (L)</label>
                                    <input type="number" id="tank_volume" class="form-control" value="1500" step="50">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Flow Rate (L/h)</label>
                                    <input type="number" id="flow_rate" class="form-control" value="50" step="5">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label class="form-label">Growing Area (m²)</label>
                                    <input type="number" id="system_area" class="form-control" value="10" step="0.5">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Number of Plants</label>
                                    <input type="number" id="n_plants" class="form-control" value="48" step="1">
                                </div>
                            </div>
                        </div>

                        <!-- Crop Parameters -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-leaf"></i> Crop Parameters</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Crop Coefficient (Kcb)</label>
                                    <input type="number" id="kcb" class="form-control" value="1.05" step="0.05">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Density Index (φ)</label>
                                    <input type="number" id="phi" class="form-control" value="0.8" step="0.05">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label class="form-label">Target Height (m)</label>
                                    <input type="number" id="crop_height" class="form-control" value="0.2" step="0.01">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Target LAI</label>
                                    <input type="number" id="laid" class="form-control" value="3.0" step="0.1">
                                </div>
                            </div>
                        </div>

                        <!-- Weather Configuration -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-cloud-sun"></i> Weather Configuration</h6>
                            <div class="mb-2">
                                <label class="form-label">Weather Data Source</label>
                                <select id="weather_type" class="form-select" onchange="toggleWeatherInputs()">
                                    <option value="generate">Generate Synthetic Data</option>
                                    <option value="custom">Enter Custom Data</option>
                                </select>
                            </div>
                            
                            <div id="weather_generate" class="weather-input">
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label">Start Date</label>
                                        <input type="date" id="weather_start_date" class="form-control" value="2024-04-15">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Base Temperature (°C)</label>
                                        <input type="number" id="base_temp" class="form-control" value="22" step="0.5">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="weather_custom" class="weather-input" style="display: none;">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addWeatherDay()">
                                    <i class="fas fa-plus"></i> Add Day
                                </button>
                                <div id="custom_weather_days" class="mt-2">
                                    <!-- Custom weather days will be added here -->
                                </div>
                            </div>
                        </div>

                        <!-- Nutrient Configuration -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-flask"></i> Nutrient Solution</h6>
                            <div id="nutrient_inputs">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Environmental Control -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-thermometer-half"></i> Environmental Control</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Control Strategy</label>
                                    <select id="control_strategy" class="form-select">
                                        <option value="passive">Passive (No Control)</option>
                                        <option value="basic">Basic On/Off</option>
                                        <option value="proportional" selected>Proportional</option>
                                        <option value="pid">PID Controller</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Target VPD (kPa)</label>
                                    <input type="number" id="target_vpd" class="form-control" value="0.8" step="0.1" min="0.3" max="1.5">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-4">
                                    <label class="form-label">Day Temp (°C)</label>
                                    <input type="number" id="day_temp" class="form-control" value="22" step="0.5" min="15" max="35">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Night Temp (°C)</label>
                                    <input type="number" id="night_temp" class="form-control" value="18" step="0.5" min="12" max="30">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">CO₂ (μmol/mol)</label>
                                    <input type="number" id="target_co2" class="form-control" value="1200" step="50" min="400" max="2000">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label class="form-label">Light Hours/Day</label>
                                    <input type="number" id="light_hours" class="form-control" value="16" step="0.5" min="8" max="24">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Light Intensity (μmol/m²/s)</label>
                                    <input type="number" id="light_intensity" class="form-control" value="200" step="10" min="50" max="500">
                                </div>
                            </div>
                        </div>

                        <!-- Genetic Parameters Override -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-dna"></i> Genetic Parameters (Advanced)</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="enable_genetic_override" onchange="toggleGeneticOverrides()">
                                <label class="form-check-label" for="enable_genetic_override">
                                    Override cultivar genetics (for research/breeding)
                                </label>
                            </div>
                            <div id="genetic_overrides" style="display: none;">
                                <div class="row">
                                    <div class="col-4">
                                        <label class="form-label">Max Photosynthesis</label>
                                        <input type="number" id="lfmax" class="form-control" value="1.2" step="0.1" min="0.5" max="3.0">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Specific Leaf Area</label>
                                        <input type="number" id="slavr" class="form-control" value="180" step="10" min="100" max="300">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">EC Tolerance (dS/m)</label>
                                        <input type="number" id="ec_tolerance" class="form-control" value="1.3" step="0.1" min="0.5" max="3.0">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <label class="form-label">Nitrogen Efficiency</label>
                                        <input type="number" id="nitrate_efficiency" class="form-control" value="0.85" step="0.05" min="0.3" max="1.0">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Root Activity</label>
                                        <input type="number" id="root_activity" class="form-control" value="1.0" step="0.1" min="0.3" max="2.0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stress & Growth Parameters -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-chart-line"></i> Growth & Stress Parameters</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Base Temperature (°C)</label>
                                    <input type="number" id="base_temperature" class="form-control" value="4.0" step="0.5" min="0" max="10">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Max Temperature (°C)</label>
                                    <input type="number" id="max_temperature" class="form-control" value="35.0" step="1" min="25" max="45">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-4">
                                    <label class="form-label">Water Stress Factor</label>
                                    <input type="number" id="water_stress" class="form-control" value="0.9" step="0.05" min="0.1" max="1.0">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Stress Acceleration</label>
                                    <input type="number" id="stress_acceleration" class="form-control" value="1.5" step="0.1" min="1.0" max="3.0">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Photoperiod Sensitive</label>
                                    <select id="photoperiod_sensitive" class="form-select">
                                        <option value="true" selected>Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Initial Plant State -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-seedling"></i> Initial Plant State</h6>
                            <div class="row">
                                <div class="col-4">
                                    <label class="form-label">Initial LAI</label>
                                    <input type="number" id="initial_lai" class="form-control" value="0.8" step="0.1" min="0.1" max="2.0">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Initial Height (cm)</label>
                                    <input type="number" id="initial_height" class="form-control" value="8" step="0.5" min="2" max="20">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Plant Density (/m²)</label>
                                    <input type="number" id="plant_density" class="form-control" value="25" step="1" min="5" max="100">
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" onclick="runSimulation()">
                                <i class="fas fa-play"></i> Run Simulation
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="loadDefaults()">
                                <i class="fas fa-undo"></i> Load Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header bg-success text-white d-flex justify-content-between">
                        <h5><i class="fas fa-chart-line"></i> Simulation Results</h5>
                        <div id="simulation_status" class="badge bg-light text-success">Ready</div>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 80vh;">
                        
                        <div id="results_container" class="d-none">
                            <!-- Summary Statistics -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="text-success"><i class="fas fa-chart-bar"></i> Summary Statistics</h6>
                                    <div id="summary_stats" class="row">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation Tabs -->
                            <ul class="nav nav-tabs mb-3" id="resultsTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Overview</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="biomass-tab" data-bs-toggle="tab" data-bs-target="#biomass" type="button">Biomass</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="physiology-tab" data-bs-toggle="tab" data-bs-target="#physiology" type="button">Physiology</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="stress-tab" data-bs-toggle="tab" data-bs-target="#stress" type="button">Stress</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="genetics-tab" data-bs-toggle="tab" data-bs-target="#genetics" type="button">Genetics</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="detailed-tab" data-bs-toggle="tab" data-bs-target="#detailed" type="button">Detailed Data</button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="resultsTabContent">
                                
                                <!-- Overview Tab -->
                                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                    <div class="row">
                                        <div class="col-6">
                                            <canvas id="biomass_chart"></canvas>
                                        </div>
                                        <div class="col-6">
                                            <canvas id="lai_chart"></canvas>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <canvas id="environment_chart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Biomass Tab -->
                                <div class="tab-pane fade" id="biomass" role="tabpanel">
                                    <div class="row">
                                        <div class="col-6">
                                            <canvas id="biomass_components_chart"></canvas>
                                        </div>
                                        <div class="col-6">
                                            <canvas id="growth_rate_chart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Physiology Tab -->
                                <div class="tab-pane fade" id="physiology" role="tabpanel">
                                    <div class="row">
                                        <div class="col-6">
                                            <canvas id="photosynthesis_chart"></canvas>
                                        </div>
                                        <div class="col-6">
                                            <canvas id="nitrogen_chart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stress Tab -->
                                <div class="tab-pane fade" id="stress" role="tabpanel">
                                    <div class="row">
                                        <div class="col-12">
                                            <canvas id="stress_factors_chart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Genetics Tab -->
                                <div class="tab-pane fade" id="genetics" role="tabpanel">
                                    <div class="row">
                                        <div class="col-6">
                                            <canvas id="genetics_chart"></canvas>
                                        </div>
                                        <div class="col-6" id="genetics_info">
                                            <!-- Genetics information will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Detailed Data Tab -->
                                <div class="tab-pane fade" id="detailed" role="tabpanel">
                                    <div class="d-flex justify-content-between mb-3">
                                        <h6>Daily Detailed Results</h6>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary" onclick="exportResults('csv')">
                                                <i class="fas fa-download"></i> CSV
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="exportResults('json')">
                                                <i class="fas fa-download"></i> JSON
                                            </button>
                                        </div>
                                    </div>
                                    <div id="detailed_data_table">
                                        <!-- Detailed data table will be populated here -->
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Initial message -->
                        <div id="initial_message" class="text-center text-muted my-5">
                            <i class="fas fa-seedling fa-3x mb-3"></i>
                            <h5>CROPGRO Hydroponic Simulator</h5>
                            <p>Configure your simulation parameters and click "Run Simulation" to begin advanced crop modeling.</p>
                            <div class="row mt-4">
                                <div class="col-4">
                                    <i class="fas fa-dna fa-2x text-primary"></i>
                                    <h6 class="mt-2">Genetic Parameters</h6>
                                    <small>Cultivar-specific modeling with DSSAT coefficients</small>
                                </div>
                                <div class="col-4">
                                    <i class="fas fa-chart-area fa-2x text-success"></i>
                                    <h6 class="mt-2">Advanced Physiology</h6>
                                    <small>Photosynthesis, respiration, and stress integration</small>
                                </div>
                                <div class="col-4">
                                    <i class="fas fa-microscope fa-2x text-info"></i>
                                    <h6 class="mt-2">Detailed Analysis</h6>
                                    <small>Comprehensive outputs for research and optimization</small>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-success mb-3" role="status"></div>
                    <h5>Running CROPGRO Simulation...</h5>
                    <p class="text-muted">Processing advanced crop modeling with all 11 integrated models</p>
                    <div class="progress">
                        <div id="progress_bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>